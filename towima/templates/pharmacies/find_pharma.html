{% extends 'base.html' %}
{% block title %}Find your local pharmacy{% endblock %}

{% block content %}
<section class="container-fluid" style="padding-top: 50px;">
    <div class="row" style="margin-top: 30px;">
        <div class="col-md-4 col-sm-12 text-center">
            <h2>Find your local pharmacy</h2>
        </div>
        <div class="col-md-8 col-sm-12">
            <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v2.3.0/mapbox-gl-geocoder.min.js'></script>
            <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v2.3.0/mapbox-gl-geocoder.css'
                type='text/css' />
            <div id='map' style='width: 100%; height: 500px; border-radius: 20px;'></div>

            <script>
                mapboxgl.accessToken = 'pk.eyJ1IjoibWF4aW1lYW50b2luZTE5OTciLCJhIjoiY2pubTNmNmlrMWpvdjNxdGFsdGxxaXJlayJ9.0tDqrdUlSYEOqxMSiy7j3g';
                var map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/mapbox/streets-v10',
                    center: [4.395907, 50.821190],
                    zoom: 15
                });

                // Add search bar to the map.
                map.addControl(new MapboxGeocoder({
                    accessToken: mapboxgl.accessToken
                }));

                // Add zoom and rotation controls to the map.  
                map.addControl(new mapboxgl.NavigationControl());
                // Add geolocate control to the map.
                map.addControl(new mapboxgl.GeolocateControl({
                    positionOptions: {
                        enableHighAccuracy: true
                    },
                    trackUserLocation: true
                }));

                var geojson = (function () {
                    var json = null;
                    $.ajax({
                        'async': false,
                        'global': false,
                        'url': "{% url 'pharmacies:get_locations' %}",
                        'dataType': "json",
                        'success': function (data) {
                            json = data;
                        }
                    });
                    return json;
                })();

                // add markers to map
                geojson.features.forEach(function (marker) {

                    // create a HTML element for each feature
                    var el = document.createElement('div');
                    el.className = 'marker';

                    // make a marker for each feature and add to the map
                    new mapboxgl.Marker(el)
                        .setLngLat(marker.geometry.coordinates)
                        .setPopup(new mapboxgl.Popup({ offset: 25 }) // add popups
                        .setHTML('<h3>' + marker.properties.title + '</h3><p>' + marker.properties.description + '</p>'))
                        .addTo(map);
                });
            </script>
        </div>
    </div>
    <br><br><br><br>
</section>
{% endblock %}